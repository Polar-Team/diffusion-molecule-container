name: Scheduled AI Dockerfile Updater

on:
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 8:00 AM UTC
  workflow_dispatch:

jobs:
  ai-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run GitHub Models AI agent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INSTRUCTIONS=$(cat .agents/updater.md)
          DOCKERFILE=$(cat Dockerfile)

          # Build JSON payload using jq to safely handle special characters
          PAYLOAD=$(jq -n \
            --arg instructions "$INSTRUCTIONS" \
            --arg dockerfile "$DOCKERFILE" \
            '{
              model: "openai/gpt-4o",
              temperature: 0.1,
              max_tokens: 4096,
              messages: [
                {
                  role: "system",
                  content: "You are a Dockerfile dependency update agent. You follow instructions precisely and output only what is asked. You never add commentary outside the defined output format."
                },
                {
                  role: "user",
                  content: ("You are executing the workflow defined in `.agents/updater.md`. Follow every step in those instructions precisely when deciding what to update.\n\n--- BEGIN .agents/updater.md ---\n" + $instructions + "\n--- END .agents/updater.md ---\n\nHere is the current Dockerfile to update:\n```dockerfile\n" + $dockerfile + "\n```\n\nRespond EXACTLY in this format with no text outside the markers:\n---DOCKERFILE_START---\n[updated Dockerfile content]\n---DOCKERFILE_END---\n---REASONING_START---\n[brief bullet list of what changed and what was intentionally left unchanged, referencing the updater.md steps]\n---REASONING_END---")
                }
              ]
            }')

          echo "Calling GitHub Models API..."
          RESPONSE=$(curl -sS \
            -X POST "https://models.github.ai/inference/chat/completions" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "API error: $(echo "$RESPONSE" | jq -r '.error.message')"
            exit 1
          fi

          # Extract the message content
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          echo "Raw response received."

          # Parse Dockerfile section
          echo "$CONTENT" | sed -n '/---DOCKERFILE_START---/,/---DOCKERFILE_END---/{ /---DOCKERFILE_START---/d; /---DOCKERFILE_END---/d; p }' > Dockerfile.new

          # Parse reasoning section
          echo "$CONTENT" | sed -n '/---REASONING_START---/,/---REASONING_END---/{ /---REASONING_START---/d; /---REASONING_END---/d; p }' > agent_reasoning.txt

          if [ -s Dockerfile.new ]; then
            mv Dockerfile.new Dockerfile
            echo "Dockerfile updated successfully."
          else
            echo "ERROR: AI did not return a valid Dockerfile block. Aborting."
            echo "Full response:"
            echo "$CONTENT"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n "$(git status --porcelain Dockerfile)" ]]; then
            echo "changes_exist=true" >> $GITHUB_ENV
          else
            echo "changes_exist=false" >> $GITHUB_ENV
            echo "No changes detected â€” Dockerfile is already up to date."
          fi

      - name: Commit and push branch
        if: env.changes_exist == 'true'
        run: |
          BRANCH_NAME="ai-dockerfile-update-$(date +%Y%m%d-%H%M)"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add Dockerfile
          git commit -m "chore(docker): AI proposed dependency updates"
          git push origin "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create pull request
        if: env.changes_exist == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REASONING=""
          if [ -f agent_reasoning.txt ]; then
            REASONING=$(cat agent_reasoning.txt)
          fi

          PR_BODY=$(cat <<EOF
          ## AI Dockerfile Dependency Update

          This PR was automatically generated by the scheduled AI updater using **GitHub Models (gpt-4.1)**.
          The agent followed the instructions in \`.agents/updater.md\`.

          ### What the agent changed:
          ${REASONING}

          ---
          > Please review the diff carefully before merging. The agent is instructed to be conservative but manual verification is always recommended.
          EOF
          )

          gh pr create \
            --title "chore(docker): AI proposed dependency updates ($(date +%Y-%m-%d))" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ env.BRANCH_NAME }}"
