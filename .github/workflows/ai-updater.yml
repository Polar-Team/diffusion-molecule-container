name: Scheduled Dockerfile Updater

on:
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 8:00 AM UTC
  workflow_dispatch:

jobs:
  ai-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Step 1: Resolve latest versions from upstream ──────────────────────
      - name: Resolve latest versions
        id: versions
        run: |
          echo "::group::Resolving upstream versions"

          # Docker DinD — latest tag matching *-dind-alpine3.23
          DIND=$(curl --max-time 30 --connect-timeout 10 -sS \
            "https://hub.docker.com/v2/repositories/library/docker/tags/?page_size=100" \
            | jq -r '.results[].name' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-dind-alpine3\.23$' \
            | sort -V | tail -1)
          if [ -z "$DIND" ]; then
            echo "::error::Failed to resolve DinD version from Docker Hub"
            exit 1
          fi
          echo "dind=$DIND" >> $GITHUB_OUTPUT
          echo "Resolved DinD: $DIND"

          # uv — latest release from GitHub (stay on current minor to avoid breaking changes)
          CURRENT_UV=$(grep 'UV_VERSION' Dockerfile | head -1 | grep -oP '[\d]+\.[\d]+\.[\d]+')
          CURRENT_UV_MINOR=$(echo "$CURRENT_UV" | cut -d. -f1-2)
          echo "Current uv: $CURRENT_UV (minor series: $CURRENT_UV_MINOR)"
          UV=$(curl --max-time 30 --connect-timeout 10 -sS \
            "https://api.github.com/repos/astral-sh/uv/releases?per_page=50" \
            | jq -r '.[].tag_name' \
            | grep -E "^${CURRENT_UV_MINOR}\." \
            | sort -V | tail -1)
          if [ -z "$UV" ]; then
            UV=$CURRENT_UV
            echo "::warning::Could not resolve uv version, keeping current: $UV"
          fi
          echo "uv=$UV" >> $GITHUB_OUTPUT
          echo "Resolved uv: $UV"

          # Python versions — latest patch for each minor in use
          CURRENT_VERSIONS=$(grep 'PYTHON_VERSIONS' Dockerfile | head -1 | grep -oP '[\d]+\.[\d]+\.[\d]+' | tr '\n' ' ')
          echo "Current Python versions: $CURRENT_VERSIONS"

          PYTHON_RELEASES=$(curl --max-time 30 --connect-timeout 10 -sS \
            "https://www.python.org/api/v2/downloads/release/?format=json&limit=200&ordering=-name")
          UPDATED_VERSIONS=""
          for VER in $CURRENT_VERSIONS; do
            MINOR=$(echo "$VER" | cut -d. -f1-2)
            LATEST=$(echo "$PYTHON_RELEASES" \
              | jq -r '.[].name' \
              | grep -E "^Python ${MINOR//./\\.}\.[0-9]+$" \
              | grep -oP "${MINOR//./\\.}\.[0-9]+" \
              | sort -V | tail -1)
            if [ -z "$LATEST" ]; then
              LATEST=$VER
            fi
            UPDATED_VERSIONS="$UPDATED_VERSIONS $LATEST"
          done
          UPDATED_VERSIONS=$(echo "$UPDATED_VERSIONS" | xargs)  # trim whitespace
          echo "python_versions=$UPDATED_VERSIONS" >> $GITHUB_OUTPUT
          echo "Resolved Python versions: $UPDATED_VERSIONS"

          # Alpine package versions — fetch each from pkgs.alpinelinux.org
          fetch_apk_version() {
            local pkg="$1"
            local ver
            ver=$(curl --max-time 10 --connect-timeout 5 -sS \
              "https://pkgs.alpinelinux.org/package/v3.23/main/x86_64/$pkg" \
              | grep -A3 'class="header">Version' \
              | grep -oP '(?<=<strong>)[\d]+\.[\d.]+(-r[\d]+)?(?=</strong>)' | head -1)
            if [ -z "$ver" ]; then
              echo "::warning::Could not resolve version for Alpine package: $pkg"
            fi
            echo "$ver"
          }

          OPENSSL_VER=$(fetch_apk_version openssl)
          OPENSSL_DEV_VER=$(fetch_apk_version openssl-dev)
          GIT_VER=$(fetch_apk_version git)
          CURL_VER=$(fetch_apk_version curl)
          BASH_VER=$(fetch_apk_version bash)
          GCC_VER=$(fetch_apk_version gcc)
          MUSL_VER=$(fetch_apk_version musl)
          LIBFFI_VER=$(fetch_apk_version libffi)
          MAKE_VER=$(fetch_apk_version make)
          BZIP2_VER=$(fetch_apk_version bzip2)
          ZLIB_VER=$(fetch_apk_version zlib)
          READLINE_VER=$(fetch_apk_version readline)
          SQLITE_VER=$(fetch_apk_version sqlite-dev)
          XZ_VER=$(fetch_apk_version xz)
          TK_VER=$(fetch_apk_version tk)
          PATCH_VER=$(fetch_apk_version patch)

          echo "openssl=$OPENSSL_VER"           >> $GITHUB_OUTPUT
          echo "openssl_dev=$OPENSSL_DEV_VER"   >> $GITHUB_OUTPUT
          echo "git=$GIT_VER"                   >> $GITHUB_OUTPUT
          echo "curl=$CURL_VER"                 >> $GITHUB_OUTPUT
          echo "bash=$BASH_VER"                 >> $GITHUB_OUTPUT
          echo "gcc=$GCC_VER"                   >> $GITHUB_OUTPUT
          echo "musl=$MUSL_VER"                 >> $GITHUB_OUTPUT
          echo "libffi=$LIBFFI_VER"             >> $GITHUB_OUTPUT
          echo "make=$MAKE_VER"                 >> $GITHUB_OUTPUT
          echo "bzip2=$BZIP2_VER"               >> $GITHUB_OUTPUT
          echo "zlib=$ZLIB_VER"                 >> $GITHUB_OUTPUT
          echo "readline=$READLINE_VER"         >> $GITHUB_OUTPUT
          echo "sqlite=$SQLITE_VER"             >> $GITHUB_OUTPUT
          echo "xz=$XZ_VER"                     >> $GITHUB_OUTPUT
          echo "tk=$TK_VER"                     >> $GITHUB_OUTPUT
          echo "patch=$PATCH_VER"               >> $GITHUB_OUTPUT

          echo "::endgroup::"
          echo "All versions resolved successfully."

      # ── Step 2: Apply resolved versions directly to the Dockerfile ────────
      - name: Apply version updates directly
        run: |
          DIND="${{ steps.versions.outputs.dind }}"
          UV="${{ steps.versions.outputs.uv }}"
          UPDATED_VERSIONS="${{ steps.versions.outputs.python_versions }}"
          GIT_VER="${{ steps.versions.outputs.git }}"
          CURL_VER="${{ steps.versions.outputs.curl }}"
          BASH_VER="${{ steps.versions.outputs.bash }}"
          GCC_VER="${{ steps.versions.outputs.gcc }}"
          MUSL_VER="${{ steps.versions.outputs.musl }}"
          LIBFFI_VER="${{ steps.versions.outputs.libffi }}"
          MAKE_VER="${{ steps.versions.outputs.make }}"
          OPENSSL_VER="${{ steps.versions.outputs.openssl }}"
          BZIP2_VER="${{ steps.versions.outputs.bzip2 }}"
          ZLIB_VER="${{ steps.versions.outputs.zlib }}"
          READLINE_VER="${{ steps.versions.outputs.readline }}"
          SQLITE_VER="${{ steps.versions.outputs.sqlite }}"
          XZ_VER="${{ steps.versions.outputs.xz }}"
          TK_VER="${{ steps.versions.outputs.tk }}"
          PATCH_VER="${{ steps.versions.outputs.patch }}"

          # Replace version variables directly in Dockerfile
          sed -i "s/DIND_VERSION=.*/DIND_VERSION=${DIND}/" Dockerfile
          sed -i "s/UV_VERSION=.*/UV_VERSION=${UV}/" Dockerfile
          sed -i "s/PYTHON_VERSIONS=.*/PYTHON_VERSIONS=\"${UPDATED_VERSIONS}\"/" Dockerfile

          # Replace Alpine package versions
          sed -i "s/git=[0-9][^[:space:]]*/git=${GIT_VER}/g" Dockerfile
          sed -i "s/curl=[0-9][^[:space:]]*/curl=${CURL_VER}/g" Dockerfile
          sed -i "s/bash=[0-9][^[:space:]]*/bash=${BASH_VER}/g" Dockerfile
          sed -i "s/gcc=[0-9][^[:space:]]*/gcc=${GCC_VER}/g" Dockerfile
          sed -i "s/musl=[0-9][^[:space:]]*/musl=${MUSL_VER}/g" Dockerfile
          sed -i "s/musl-dev=[0-9][^[:space:]]*/musl-dev=${MUSL_VER}/g" Dockerfile
          sed -i "s/libffi=[0-9][^[:space:]]*/libffi=${LIBFFI_VER}/g" Dockerfile
          sed -i "s/libffi-dev=[0-9][^[:space:]]*/libffi-dev=${LIBFFI_VER}/g" Dockerfile
          sed -i "s/make=[0-9][^[:space:]]*/make=${MAKE_VER}/g" Dockerfile
          sed -i "s/openssl=[0-9][^[:space:]]*/openssl=${OPENSSL_VER}/g" Dockerfile
          sed -i "s/openssl-dev=[0-9][^[:space:]]*/openssl-dev=${OPENSSL_VER}/g" Dockerfile
          sed -i "s/bzip2=[0-9][^[:space:]]*/bzip2=${BZIP2_VER}/g" Dockerfile
          sed -i "s/bzip2-dev=[0-9][^[:space:]]*/bzip2-dev=${BZIP2_VER}/g" Dockerfile
          sed -i "s/zlib=[0-9][^[:space:]]*/zlib=${ZLIB_VER}/g" Dockerfile
          sed -i "s/zlib-dev=[0-9][^[:space:]]*/zlib-dev=${ZLIB_VER}/g" Dockerfile
          sed -i "s/readline=[0-9][^[:space:]]*/readline=${READLINE_VER}/g" Dockerfile
          sed -i "s/readline-dev=[0-9][^[:space:]]*/readline-dev=${READLINE_VER}/g" Dockerfile
          sed -i "s/sqlite-dev=[0-9][^[:space:]]*/sqlite-dev=${SQLITE_VER}/g" Dockerfile
          sed -i "s/xz=[0-9][^[:space:]]*/xz=${XZ_VER}/g" Dockerfile
          sed -i "s/xz-dev=[0-9][^[:space:]]*/xz-dev=${XZ_VER}/g" Dockerfile
          sed -i "s/tk=[0-9][^[:space:]]*/tk=${TK_VER}/g" Dockerfile
          sed -i "s/tk-dev=[0-9][^[:space:]]*/tk-dev=${TK_VER}/g" Dockerfile
          sed -i "s/patch=[0-9][^[:space:]]*/patch=${PATCH_VER}/g" Dockerfile

          # Generate a simple summary of what was updated
          if ! git diff --quiet Dockerfile; then
            echo "Updated versions in Dockerfile:" > update_summary.txt
            echo "- DIND: ${DIND}" >> update_summary.txt
            echo "- UV: ${UV}" >> update_summary.txt
            echo "- Python: ${UPDATED_VERSIONS}" >> update_summary.txt
            echo "- Alpine packages: updated to latest available versions" >> update_summary.txt
          else
            echo "No changes needed - all versions were already up to date." > update_summary.txt
          fi

      # ── Step 3: Commit, push, open PR ──────────────────────────────────────
      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n "$(git status --porcelain Dockerfile)" ]]; then
            echo "changes_exist=true" >> $GITHUB_ENV
            echo "Changes detected in Dockerfile."
          else
            echo "changes_exist=false" >> $GITHUB_ENV
            echo "No changes detected — Dockerfile is already up to date."
          fi

      - name: Commit and push branch
        if: env.changes_exist == 'true'
        run: |
          BRANCH_NAME="dockerfile-update-$(date +%Y%m%d-%H%M)"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add Dockerfile
          git commit -m "chore(docker): automated dependency updates"
          git push origin "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Branch $BRANCH_NAME pushed successfully."

      - name: Create pull request
        if: env.changes_exist == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REASONING=$(cat update_summary.txt 2>/dev/null || echo "No summary available.")
          PR_BODY=$(cat <<EOF
          ## Dockerfile Dependency Update

          Automatically generated by the scheduled Dockerfile updater.
          Versions were resolved from upstream sources and applied directly to the Dockerfile.

          ### Changes summary:
          ${REASONING}

          ---
          > Review the diff carefully before merging.
          EOF
          )

          gh pr create \
            --title "chore(docker): dependency updates ($(date +%Y-%m-%d))" \
            --body "$PR_BODY" \
            --base master \
            --head "${{ env.BRANCH_NAME }}"
